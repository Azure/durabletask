steps:
  - bash: |
      echo "Installing azurite"
      npm install -g azurite
      mkdir azurite1
      echo "azurite installed"
      azurite --silent --location azurite1 --debug azurite1\debug.txt --queuePort 10001 &
      echo "azurite started"
      sleep 5
    displayName: 'Install and Run Azurite'

  - task: VSBuild@1
    displayName: 'Build (Core Tests)'
    inputs:
      solution: '.\Test\DurableTask.Core.Tests\DurableTask.Core.Tests.csproj'
      vsVersion: '16.0'
      logFileVerbosity: minimal
      configuration: Release
      msbuildArgs: /p:FileVersionRevision=$(Build.BuildId) /p:ContinuousIntegrationBuild=true

  - task: VSBuild@1
    displayName: 'Build (AzureStorage Tests)'
    inputs:
      solution: '.\Test\DurableTask.AzureStorage.Tests\DurableTask.AzureStorage.Tests.csproj'
      vsVersion: '16.0'
      logFileVerbosity: minimal
      configuration: Release
      msbuildArgs: /p:FileVersionRevision=$(Build.BuildId) /p:ContinuousIntegrationBuild=true

  - task: VSBuild@1
    displayName: 'Build (Emulator Tests)'
    inputs:
      solution: '.\Test\DurableTask.Emulator.Tests\DurableTask.Emulator.Tests.csproj'
      vsVersion: '16.0'
      logFileVerbosity: minimal
      configuration: Release
      msbuildArgs: /p:FileVersionRevision=$(Build.BuildId) /p:ContinuousIntegrationBuild=true

  - task: VSTest@2
    displayName: 'Run unit and functional tests'
    inputs:
      testAssemblyVer2: |
        **\bin\**\DurableTask.AzureStorage.Tests.dll
        **\bin\**\DurableTask.Core.Tests.dll
        **\bin\**\DurableTask.Emulator.Tests.dll
        !**\obj\**
        testFiltercriteria: 'TestCategory!=DisabledInCI'
        vsTestVersion: 16.0
        distributionBatchType: basedOnExecutionTime
        platform: 'any cpu'
        configuration: 'Debug'
        diagnosticsEnabled: True
        collectDumpOn: always
        rerunFailedTests: true
        rerunFailedThreshold: 20
        rerunMaxAttempts: 2